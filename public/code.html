<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TinyLink — Link stats</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .focus-ring:focus { outline: 3px solid rgba(15,98,254,0.12); outline-offset: 2px; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <a href="/" class="text-blue-600 mb-4 inline-block">← Back to Dashboard</a>

    <div id="card" class="bg-white rounded-xl shadow p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-lg font-semibold" id="codeTitle">Code: —</h1>
          <p id="targetUrl" class="text-sm text-slate-600 mt-1 break-words"></p>
        </div>

        <div class="text-right">
          <div class="text-sm text-slate-500">Clicks</div>
          <div id="clicks" class="text-2xl font-bold mt-1">—</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 bg-slate-50 rounded">
          <div class="text-xs text-slate-500">Created at</div>
          <div id="createdAt" class="text-sm text-slate-700">—</div>
        </div>
        <div class="p-4 bg-slate-50 rounded">
          <div class="text-xs text-slate-500">Last clicked</div>
          <div id="lastClicked" class="text-sm text-slate-700">—</div>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <!-- FIXED anchor: Added rel, default href -->
        <a id="openLink" href="#" target="_blank" rel="noopener noreferrer"
           class="px-4 py-2 bg-blue-600 text-white rounded-md inline-flex items-center gap-2">
           Open link
        </a>
        <button id="delBtn" class="px-3 py-2 bg-red-600 text-white rounded-md">Delete</button>
        <button id="copyBtn" class="px-3 py-2 bg-slate-100 rounded-md">Copy short URL</button>
      </div>

      <div id="loading" class="mt-4 text-sm text-slate-500">Loading...</div>
    </div>
  </div>

  <script>

    /* ✅ FIX — Always fix URLs missing http:// or https:// */
    function normalize(url) {
      if (!url.startsWith("http://") && !url.startsWith("https://")) {
        return "https://" + url;
      }
      return url;
    }

    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    document.getElementById('codeTitle').innerText = code ? `Code: ${code}` : 'Code: —';

    async function load() {
      if (!code) {
        document.getElementById('loading').innerText = 'No code supplied in URL (use ?code=)';
        return;
      }

      try {
        const res = await fetch(`/api/links/${code}`);
        if (!res.ok) {
          document.getElementById('loading').innerText = 'Code not found';
          return;
        }

        const data = await res.json();

        // FIXED — Apply normalization
        const fullURL = normalize(data.long_url);

        document.getElementById('targetUrl').innerText = fullURL;
        document.getElementById('openLink').href = fullURL;

        document.getElementById('clicks').innerText = data.clicks;
        document.getElementById('createdAt').innerText = new Date(data.created_at).toLocaleString();
        document.getElementById('lastClicked').innerText =
          data.last_clicked ? new Date(data.last_clicked).toLocaleString() : 'Never';

        document.getElementById('loading').style.display = 'none';

      } catch (err) {
        document.getElementById('loading').innerText = 'Error loading data';
      }
    }

    load();

    document.getElementById('copyBtn').onclick = () => {
      const base = window.location.origin;
      navigator.clipboard.writeText(`${base}/${code}`);
      alert('Copied short URL to clipboard');
    };

    document.getElementById('delBtn').onclick = async () => {
      if (!confirm('Delete this link?')) return;
      const res = await fetch(`/api/links/${code}`, { method: 'DELETE' });
      if (res.ok) {
        alert('Deleted — returning to dashboard');
        location.href = '/';
      } else {
        alert('Delete failed');
      }
    };
  </script>
</body>
</html>
